<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>HFPI Defects Dashboard</title>

    <link rel="stylesheet" href="/css/hfpi-defects.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>

<body>

<nav class="breadcrumb">
    <a th:href="@{/}">ğŸ­ Manufacturing Index</a> â€º
    <a th:href="@{/hfpi/{id}(id=${factory.id})}">HFPI</a> â€º
    <span th:text="${factory.name}"></span> â€º
    <span id="breadcrumbFYQ"></span>
</nav>

<!-- ================= FILTROS ================= -->
<label>Factory:</label>
<select onchange="changeFactory(this.value)">
    <option th:each="f : ${factories}"
            th:value="${f.id}"
            th:text="${f.name}"
            th:selected="${f.id == factoryId}">
    </option>
</select>

<div class="filters-card">
    <label>FY:</label>
    <select id="fySelect"></select>

    <label>Quarter:</label>
    <select id="quarterSelect"></select>
</div>

<!-- ================= TOGGLE ================= -->
<div class="view-toggle">
    <button id="btnType" class="btn-primary">ğŸ“Š Por Tipo</button>
    <button id="btnModel" class="btn-secondary">ğŸ‘Ÿ Por Modelo</button>
</div>

<!-- ================= POR TIPO ================= -->
<section id="typeSection" style="margin-top:20px;">
    <h3>Pareto â€“ Defeitos por Tipo (80/20)</h3>
    <div class="chart-box">
        <canvas id="defectPareto"></canvas>
    </div>
</section>

<!-- ================= POR MODELO ================= -->
<section id="modelSection" style="display:none; margin-top:20px;">
    <label>Models:</label>
    <select id="modelSelect" size="6" style="min-width:220px;"></select>
    <small>Selecione 1 modelo</small>

    <h3 style="margin-top:20px;">Pareto â€“ Defeitos por Modelo (80/20)</h3>
    <div style="height:420px;">
        <canvas id="modelChart"></canvas>
    </div>
</section>

<script th:inline="javascript">
Chart.register(ChartDataLabels);

const factoryId = [[${factoryId}]];

/* ================= ELEMENTOS ================= */
const fySelect = document.getElementById("fySelect");
const quarterSelect = document.getElementById("quarterSelect");
const breadcrumbFYQ = document.getElementById("breadcrumbFYQ");

const btnType = document.getElementById("btnType");
const btnModel = document.getElementById("btnModel");

const typeSection = document.getElementById("typeSection");
const modelSection = document.getElementById("modelSection");

const modelSelect = document.getElementById("modelSelect");
const modelCanvas = document.getElementById("modelChart");
const defectPareto = document.getElementById("defectPareto");

let paretoChart = null;
let modelChart = null;

/* ================= FY / QUARTER ================= */
function loadFYs() {
    fetch("/hfpi/defects/fys")
        .then(r => r.json())
        .then(fys => {
            fySelect.innerHTML = "";
            fys.forEach((fy, i) =>
                fySelect.add(new Option(fy, fy, i === 0, i === 0))
            );
            loadQuarters();
        });
}

function loadQuarters() {
    fetch(`/hfpi/defects/quarters?fy=${fySelect.value}`)
        .then(r => r.json())
        .then(qs => {
            quarterSelect.innerHTML = "";
            qs.forEach((q, i) =>
                quarterSelect.add(new Option(q, q, i === 0, i === 0))
            );
            breadcrumbFYQ.textContent = `${fySelect.value} ${quarterSelect.value}`;
            loadTypePareto();
        });
}

/* ================= PARETO POR TIPO ================= */
function loadTypePareto() {
    fetch(`/hfpi/defects/data?factoryId=${factoryId}&fy=${fySelect.value}&quarter=${quarterSelect.value}`)
        .then(r => r.json())
        .then(data => {
            if (!data.length) return;

            data.sort((a, b) => b.count - a.count);
            renderTypePareto(
                data.map(d => d.defectName),
                data.map(d => d.count)
            );
        });
}

function renderTypePareto(labels, values) {
    if (paretoChart) paretoChart.destroy();

    let acc = 0;
    const total = values.reduce((a, b) => a + b, 0);
    const perc = values.map(v => ((acc += v) / total * 100).toFixed(1));

    paretoChart = new Chart(defectPareto, {
        data: {
            labels,
            datasets: [
                { type: "bar", label: "Quantidade", data: values },
                { type: "line", label: "% Acumulado", data: perc, yAxisID: "y1" }
            ]
        },
        options: { indexAxis: "y", scales: { y1: { max: 100, position: "right" } } }
    });
}

/* ================= MODELO ================= */
function loadModels() {
    fetch(`/hfpi/defects/data/models?factoryId=${factoryId}&fy=${fySelect.value}&quarter=${quarterSelect.value}`)
        .then(r => r.json())
        .then(data => {
            modelSelect.innerHTML = "";
            data.forEach(d => modelSelect.add(new Option(d.defectName, d.defectName)));
        });
}

function loadParetoByModel(model) {
    fetch(`/hfpi/defects/pareto/model?factoryId=${factoryId}&fy=${fySelect.value}&quarter=${quarterSelect.value}&modelName=${encodeURIComponent(model)}`)
        .then(r => r.json())
        .then(renderModelPareto);
}

function renderModelPareto(data) {
    if (!data.length) return;

    data.sort((a, b) => b.count - a.count);
    const labels = data.map(d => d.defectName);
    const values = data.map(d => d.count);

    if (modelChart) modelChart.destroy();
    modelChart = new Chart(modelCanvas, {
        data: {
            labels,
            datasets: [{ type: "bar", label: "Quantidade", data: values }]
        },
        options: { indexAxis: "y" }
    });
}

/* ================= EVENTS ================= */
btnType.onclick = () => {
    btnType.className = "btn-primary";
    btnModel.className = "btn-secondary";
    typeSection.style.display = "block";
    modelSection.style.display = "none";
};

btnModel.onclick = () => {
    btnModel.className = "btn-primary";
    btnType.className = "btn-secondary";
    typeSection.style.display = "none";
    modelSection.style.display = "block";
    loadModels();
};

modelSelect.onchange = () => {
    if (modelSelect.value) loadParetoByModel(modelSelect.value);
};

fySelect.onchange = loadQuarters;
quarterSelect.onchange = () => {
    loadTypePareto();
    if (modelSection.style.display === "block") loadModels();
};

loadFYs();
</script>

<script>
function changeFactory(factoryId) {
    window.location.replace(`/hfpi/defects/${factoryId}`);
}
</script>

</body>
</html>
