<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>HFPI Defects Dashboard</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/hfpi-defects.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Chart DataLabels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>

<body>

	
	<nav class="breadcrumb">
	    <a th:href="@{/}">ğŸ­ Manufacturing Index</a>
	    <span>â€º</span>

	    <a th:href="@{/hfpi/{id}(id=${factory.id})}">HFPI</a>
	    <span>â€º</span>

	    <span th:text="${factory.name}">Factory</span>
	    <span>â€º</span>

	    <span id="breadcrumbFYQ" class="current">
	        FY â€“ Q
	    </span>
	</nav>




<!-- FILTROS -->
<div class="filters-card">
    <label>FY:</label>
    <select id="fySelect"></select>

    <label>Quarter:</label>
    <select id="quarterSelect"></select>
</div>

<!-- TOGGLE -->
<div class="view-toggle">
    <button id="btnPareto" class="active">ğŸ“Š Por Tipo</button>
    <button id="btnModel">ğŸ‘Ÿ Por Modelo</button>
</div>

<hr>

<!-- ===============================
     VISÃƒO POR TIPO
     =============================== -->
<div class="charts-column" id="typeView">

    <div class="chart-card">
        <h3>Defeitos por Tipo</h3>
        <div class="pie-wrapper">
            <canvas id="defectPie"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <h3>Pareto â€“ Defeitos (80/20)</h3>
        <div class="bar-wrapper">
            <canvas id="defectPareto"></canvas>
        </div>
    </div>

</div>

<!-- ===============================
     VISÃƒO POR MODELO
     =============================== -->
<div class="charts-column" id="modelView" style="display:none">

    <div class="chart-card">
        <h3>Defeitos por Modelo</h3>
        <div class="bar-wrapper">
            <canvas id="modelBar"></canvas>
        </div>
    </div>

</div>

<script>
Chart.register(ChartDataLabels);

let pieChart = null;
let paretoChart = null;
let modelChart = null;

/* ===============================
   LOAD FY
   =============================== */
function loadFYs() {
    fetch("/hfpi/defects/fys")
        .then(res => res.json())
        .then(fys => {
            const fySelect = document.getElementById("fySelect");
            fySelect.innerHTML = "";
            fys.forEach(fy => {
                const opt = document.createElement("option");
                opt.value = fy;
                opt.textContent = fy;
                fySelect.appendChild(opt);
            });
            loadQuarters();
        });
}

/* ===============================
   LOAD QUARTERS
   =============================== */
function loadQuarters() {
    const fy = fySelect.value;

    fetch(`/hfpi/defects/quarters?fy=${fy}`)
        .then(res => res.json())
        .then(quarters => {
            quarterSelect.innerHTML = "";
            quarters.forEach(q => {
                const opt = document.createElement("option");
                opt.value = q;
                opt.textContent = q;
                quarterSelect.appendChild(opt);
            });
            loadDefectData();
			updateBreadcrumbFYQ();

        });
}

/* ===============================
   DATA POR TIPO
   =============================== */
   function updateBreadcrumbFYQ() {
       const fy = document.getElementById("fySelect").value;
       const quarter = document.getElementById("quarterSelect").value;

       const el = document.getElementById("breadcrumbFYQ");

       if (fy && quarter) {
           el.textContent = fy + " " + quarter;
       }
   }

   
function loadDefectData() {

    const fy = fySelect.value;
    const quarter = quarterSelect.value;

    fetch(`/hfpi/defects/data?factoryId=1&fy=${fy}&quarter=${quarter}`)
        .then(res => res.json())
        .then(data => {

            if (!data || data.length === 0) return;

            data.sort((a, b) => b.count - a.count);

            const labels = data.map(d => d.defectName);
            const values = data.map(d => d.count);

            updatePie(labels, values);
            updatePareto(labels, values);
			updateBreadcrumbFYQ();

			
        });
}

/* ===============================
   ğŸ• PIE
   =============================== */
function updatePie(labels, values) {

    if (pieChart) pieChart.destroy();

    pieChart = new Chart(defectPie, {
        type: "pie",
        data: { labels, datasets: [{ data: values }] },
        options: {
            plugins: {
                legend: { position: "bottom" },
                datalabels: {
                    color: "#fff",
                    font: { weight: "bold" },
                    formatter: v => v
                }
            }
        }
    });
}

/* ===============================
   ğŸ“ˆ PARETO
   =============================== */
function updatePareto(labels, values) {

    if (paretoChart) paretoChart.destroy();

    const total = values.reduce((a, b) => a + b, 0);
    let acc = 0;

    const perc = values.map(v => {
        acc += v;
        return ((acc / total) * 100).toFixed(1);
    });

    paretoChart = new Chart(defectPareto, {
        data: {
            labels,
            datasets: [
                {
                    type: "bar",
                    label: "Quantidade",
                    data: values,
                    backgroundColor: "#3b82f6",
                    yAxisID: "y"
                },
                {
                    type: "line",
                    label: "% Acumulado",
                    data: perc,
                    borderColor: "#ef4444",
                    tension: 0.3,
                    yAxisID: "y1",
                    datalabels: {
                        formatter: v => v + "%",
                        color: "#ef4444",
                        align: "right"
                    }
                }
            ]
        },
        options: {
            indexAxis: "y",
            scales: {
                y: { beginAtZero: true },
                y1: {
                    beginAtZero: true,
                    max: 100,
                    position: "right",
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

/* ===============================
   ğŸ‘Ÿ MODELO
   =============================== */
function loadModelData() {

    const fy = fySelect.value;
    const quarter = quarterSelect.value;

    fetch(`/hfpi/defects/models?factoryId=1&fy=${fy}&quarter=${quarter}`)
        .then(res => res.json())
        .then(data => {

            if (!data || data.length === 0) return;

            const labels = data.map(d => d.defectName);
            const values = data.map(d => d.count);

            if (modelChart) modelChart.destroy();

            modelChart = new Chart(modelBar, {
                type: "bar",
                data: {
                    labels,
                    datasets: [{
                        label: "Quantidade de Defeitos",
                        data: values,
                        backgroundColor: "#22c55e"
                    }]
                },
                options: {
                    indexAxis: "y",
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        });
}

/* ===============================
   TOGGLE
   =============================== */
btnPareto.onclick = () => {
    typeView.style.display = "flex";
    modelView.style.display = "none";
    btnPareto.classList.add("active");
    btnModel.classList.remove("active");
};

btnModel.onclick = () => {
    typeView.style.display = "none";
    modelView.style.display = "flex";
    btnModel.classList.add("active");
    btnPareto.classList.remove("active");
    loadModelData();
};

/* ===============================
   INIT
   =============================== */
document.addEventListener("DOMContentLoaded", () => {
    loadFYs();
    fySelect.onchange = loadQuarters;
    quarterSelect.onchange = () => {
        loadDefectData();
        if (btnModel.classList.contains("active")) {
            loadModelData();
        }
    };
});
</script>

</body>
</html>
