<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>HFPI Defects Dashboard</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/hfpi-defects.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Chart DataLabels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>

<body>

	<div class="dashboard-header">
	    <div class="header-left">
	        <h2>ðŸ“Š HFPI â€“ Defects Dashboard</h2>
	    </div>

	    <div class="header-right">
	        <a href="/hfpi/1" class="btn-back">
	            â¬… Voltar para HFPI
	        </a>
	    </div>
	</div>

<!-- FILTROS -->
<div class="filters-card">
    <label>FY:</label>
    <select id="fySelect"></select>

    <label>Quarter:</label>
    <select id="quarterSelect"></select>
</div>

<hr>

<!-- GRÃFICOS (VERTICAL) -->
<div class="charts-column">

    <!-- ðŸ• PIZZA -->
    <div class="chart-card">
        <h3>Defeitos por Tipo</h3>
        <div class="pie-wrapper">
            <canvas id="defectPie"></canvas>
        </div>
    </div>

    <!-- ðŸ“ˆ PARETO -->
    <div class="chart-card">
        <h3>Pareto â€“ Defeitos (80/20)</h3>
        <div class="bar-wrapper">
            <canvas id="defectPareto"></canvas>
        </div>
    </div>

</div>

<script>
console.log("ðŸš€ JS carregado");

Chart.register(ChartDataLabels);

let pieChart = null;
let paretoChart = null;

/* ===============================
   CARREGA FYs
   =============================== */
function loadFYs() {
    fetch("/hfpi/defects/fys")
        .then(res => res.json())
        .then(fys => {
            const fySelect = document.getElementById("fySelect");
            fySelect.innerHTML = "";

            fys.forEach(fy => {
                const opt = document.createElement("option");
                opt.value = fy;
                opt.textContent = fy;
                fySelect.appendChild(opt);
            });

            loadQuarters();
        });
}

/* ===============================
   CARREGA QUARTERS
   =============================== */
function loadQuarters() {
    const fy = document.getElementById("fySelect").value;

    fetch(`/hfpi/defects/quarters?fy=${fy}`)
        .then(res => res.json())
        .then(quarters => {
            const quarterSelect = document.getElementById("quarterSelect");
            quarterSelect.innerHTML = "";

            quarters.forEach(q => {
                const opt = document.createElement("option");
                opt.value = q;
                opt.textContent = q;
                quarterSelect.appendChild(opt);
            });

            loadDefectData();
        });
}

/* ===============================
   BUSCA DADOS
   =============================== */
function loadDefectData() {

    const fy = document.getElementById("fySelect").value;
    const quarter = document.getElementById("quarterSelect").value;

    console.log("ðŸ“¡ buscando dados:", fy, quarter);

    fetch(`/hfpi/defects/data?factoryId=1&fy=${fy}&quarter=${quarter}`)
        .then(res => res.json())
        .then(data => {

            console.log("ðŸ“Š dados recebidos:", data);

            if (!data || data.length === 0) {
                console.warn("Sem dados para este filtro");
                return;
            }

            // ordena do maior para o menor
            data.sort((a, b) => b.count - a.count);

            const labels = data.map(d => d.defectName);
            const values = data.map(d => d.count);

            updatePie(labels, values);
            updatePareto(labels, values);
        });
}

/* ===============================
   ðŸ• GRÃFICO DE PIZZA
   =============================== */
function updatePie(labels, values) {

    if (pieChart) pieChart.destroy();

    pieChart = new Chart(
        document.getElementById("defectPie"),
        {
            type: "pie",
            data: {
                labels,
                datasets: [{ data: values }]
            },
            options: {
                plugins: {
                    legend: { position: "bottom" },
                    datalabels: {
                        color: "#fff",
                        font: { weight: "bold" },
                        formatter: v => v
                    }
                }
            }
        }
    );
}

/* ===============================
   ðŸ“ˆ GRÃFICO DE PARETO (80/20)
   =============================== */
function updatePareto(labels, values) {

    if (paretoChart) paretoChart.destroy();

    const total = values.reduce((a, b) => a + b, 0);

    let acumulado = 0;
    const percentuais = values.map(v => {
        acumulado += v;
        return ((acumulado / total) * 100).toFixed(1);
    });

    paretoChart = new Chart(
        document.getElementById("defectPareto"),
        {
            data: {
                labels,
                datasets: [
                    {
                        type: "bar",
                        label: "Quantidade",
                        data: values,
                        backgroundColor: "#3b82f6",
                        yAxisID: "y"
                    },
                    {
                        type: "line",
                        label: "% Acumulado",
                        data: percentuais,
                        borderColor: "#ef4444",
                        backgroundColor: "#ef4444",
                        tension: 0.3,
                        yAxisID: "y1",
                        datalabels: {
                            formatter: v => v + "%",
                            color: "#ef4444",
                            align: "right"
                        }
                    }
                ]
            },
            options: {
                indexAxis: "y",
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "Quantidade"
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        max: 100,
                        position: "right",
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: "% Acumulado"
                        }
                    }
                }
            }
        }
    );
}

/* ===============================
   INIT
   =============================== */
document.addEventListener("DOMContentLoaded", () => {
    loadFYs();

    document.getElementById("fySelect")
        .addEventListener("change", loadQuarters);

    document.getElementById("quarterSelect")
        .addEventListener("change", loadDefectData);
});
</script>

</body>
</html>
